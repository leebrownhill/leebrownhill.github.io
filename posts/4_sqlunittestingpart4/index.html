<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL Unit Testing Using tSQLt: Part 4 - Lee Brownhill&#39;s Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="A blog post about SQL Unit Testing with tSQLt. Covers a tSQLt example using code examples for stored procedure and unit test">
		<meta property="og:url" content="https://leebrownhill.github.io/posts/4_sqlunittestingpart4/">
  <meta property="og:site_name" content="Lee Brownhill&#39;s Blog">
  <meta property="og:title" content="SQL Unit Testing Using tSQLt: Part 4">
  <meta property="og:description" content="A blog post about SQL Unit Testing with tSQLt. Covers a tSQLt example using code examples for stored procedure and unit test">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-29T06:00:00+00:00">
    <meta property="article:modified_time" content="2025-04-29T06:00:00+00:00">
    <meta property="article:tag" content="Sql">
    <meta property="article:tag" content="Tsql">
    <meta property="article:tag" content="Unit Testing">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
		
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7983PDFMXQ"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7983PDFMXQ');
        }
      </script>

	<meta name="author" content="Lee Brownhill">
	<meta property="og:description" content="A blog post about SQL Unit Testing with tSQLt. Covers a tSQLt example using code examples for stored procedure and unit test">
	<meta property="og:image" content="https://leebrownhill.github.io/">
	<meta property="og:image:type" content="img/png">

	






	

	<script src="/js/clarity.js"></script>
	<script src="/js/ads.js"></script>




	
	




</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	

	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="Lee Brownhill&#39;s Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/avatar.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">Lee Brownhill&#39;s Blog</div>
					<div class="logo__tagline">A blog about SQL Server, mostly</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">blog</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/talks">
				
				<span class="menu__text">talks</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about">
				
				<span class="menu__text">about</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/contact">
				
				<span class="menu__text">contact</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>


	
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL Unit Testing Using tSQLt: Part 4</h1>
			
		</header>
		<div class="content post__content clearfix">
			<br>
<p>We&rsquo;re back once again, with another instalment of the tSQLt series. I hope you&rsquo;ve been enjoying it so far. Personally, I&rsquo;ve had a blast getting back into this topic.
In the last post, we covered one of the many useful features of tSQLt, the Fake Function option.</p>
<p>Taking this further, in today&rsquo;s post, I want to cover the <a href="https://tsqlt.org/user-guide/isolating-dependencies/spyprocedure/">Spy Procedure</a> option.</p>
<br>
<br>
<h3 id="the-setup---our-stored-procedure">The Setup - Our Stored Procedure</h3>
<p>Once again, to demonstrate today&rsquo;s topic, we will complete a small demo. We&rsquo;re going to use the same procedure from the last post and build upon it slightly. As before, we will be using the StackOverflow2010 database.</p>
<p>Here is the full stored procedure that we will be testing:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">OR</span><span style="color:#fff"> </span><span style="color:#cf222e">ALTER</span><span style="color:#fff"> </span><span style="color:#cf222e">PROCEDURE</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>dbo<span style="color:#1f2328">].[</span>GetUserDetail_LastYear<span style="color:#1f2328">]</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span>DisplayName<span style="color:#fff"> </span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">100</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">AS</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">BEGIN</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">DECLARE</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>Now<span style="color:#fff">            </span>DATETIME<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">DECLARE</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>OneYearAgo<span style="color:#fff">     </span>DATETIME<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">SET</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>Now<span style="color:#fff">                </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>DateTimeNow<span style="color:#1f2328">()</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">SET</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>OneYearAgo<span style="color:#fff">         </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>DATEADD<span style="color:#1f2328">(</span><span style="color:#cf222e">YEAR</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>Now<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">SELECT</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>u<span style="color:#1f2328">.</span>DisplayName<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>u<span style="color:#1f2328">.</span><span style="color:#cf222e">Location</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>u<span style="color:#1f2328">.</span>Reputation<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">COUNT</span><span style="color:#1f2328">(</span><span style="color:#cf222e">c</span><span style="color:#1f2328">.</span>Id<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>CommentCount<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>Users<span style="color:#fff"> </span>u<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">INNER</span><span style="color:#fff"> </span><span style="color:#cf222e">JOIN</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>Comments<span style="color:#fff"> </span><span style="color:#cf222e">c</span><span style="color:#fff"> </span><span style="color:#cf222e">ON</span><span style="color:#fff"> </span>u<span style="color:#1f2328">.</span>Id<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">c</span><span style="color:#1f2328">.</span>UserId<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">WHERE</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>u<span style="color:#1f2328">.</span>DisplayName<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>DisplayName<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">AND</span><span style="color:#fff"> </span><span style="color:#cf222e">c</span><span style="color:#1f2328">.</span>CreationDate<span style="color:#fff"> </span><span style="color:#cf222e">BETWEEN</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>OneYearAgo<span style="color:#fff"> </span><span style="color:#cf222e">AND</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>Now<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">GROUP</span><span style="color:#fff"> </span><span style="color:#cf222e">BY</span><span style="color:#fff"> </span>u<span style="color:#1f2328">.</span>DisplayName<span style="color:#1f2328">,</span><span style="color:#fff"> </span>u<span style="color:#1f2328">.</span><span style="color:#cf222e">Location</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>u<span style="color:#1f2328">.</span>Reputation<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">/* Capture Execution Data */</span><span style="color:#fff">    
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">DECLARE</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">@</span>Proc<span style="color:#fff">   </span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">100</span><span style="color:#1f2328">)</span><span style="color:#fff">   </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>OBJECT_NAME<span style="color:#1f2328">(</span><span style="color:#0550ae">@@</span>PROCID<span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">@</span>Who<span style="color:#fff">    </span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">300</span><span style="color:#1f2328">)</span><span style="color:#fff">   </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>SUSER_NAME<span style="color:#1f2328">(),</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">@</span><span style="color:#cf222e">When</span><span style="color:#fff">   </span>DATETIME<span style="color:#fff">        </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>GETDATE<span style="color:#1f2328">()</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">EXEC</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>AddToAuditLog<span style="color:#fff"> </span><span style="color:#0550ae">@</span>Proc<span style="color:#1f2328">,</span><span style="color:#0550ae">@</span>Who<span style="color:#1f2328">,</span><span style="color:#0550ae">@</span><span style="color:#cf222e">When</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">END</span><span style="color:#fff">
</span></span></span></code></pre></div><p>The only addition made to the procedure, since our last post, is the addition of a call to another stored procedure, dbo.AddToAuditLog. This procedure simply captures some metadata about the procedure&rsquo;s execution, such as the procedure name, user, and time.</p>
<p>When we execute our procedure like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">EXEC</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>GetUserDetail_LastYear<span style="color:#fff"> </span><span style="color:#0550ae">@</span>DisplayName<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;Jon Skeet&#39;</span><span style="color:#fff">
</span></span></span></code></pre></div><p>We get the following results:</p>
<img src="/posts/post_images/results_2.png" alt="tsqlt" style="width:538px; height:auto;">
<br>
<br>
<p>However, this time, we are also logging information into an &lsquo;audit&rsquo; table, via our use of our embedded procedure - dbo.AddToAuditLog:</p>
<img src="/posts/post_images/results_3.png" alt="tsqlt" style="width:538px; height:auto;">
<br>
<br>
<br>
<br>
<h3 id="the-setup---our-unit-test">The Setup - Our Unit Test</h3>
<p>Our unit test currently is identical to how we finished up on the last post. The latest addition to it was the introduction of the Fake Function option.
Here is the full procedure as it currently stands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">OR</span><span style="color:#fff"> </span><span style="color:#cf222e">ALTER</span><span style="color:#fff"> </span><span style="color:#cf222e">PROCEDURE</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>tests<span style="color:#1f2328">].[</span>test<span style="color:#fff"> </span>GetUserDetail_LastYear<span style="color:#1f2328">]</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">AS</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">BEGIN</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">DECLARE</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span>UserName<span style="color:#fff"> </span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">100</span><span style="color:#1f2328">)</span><span style="color:#fff">	</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;Jon Skeet&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">/* ASSEMBLE STAGE */</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">EXEC</span><span style="color:#fff"> </span>tSQLt<span style="color:#1f2328">.</span>FakeFunction<span style="color:#fff"> </span><span style="color:#0550ae">@</span>FunctionName<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;dbo.DateTimeNow&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>FakeFunctionName<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;Fake.DateTimeNow&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">EXEC</span><span style="color:#fff"> </span>tSQLt<span style="color:#1f2328">.</span>FakeTable<span style="color:#fff"> </span><span style="color:#0a3069">&#39;dbo.Users&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">INSERT</span><span style="color:#fff"> </span><span style="color:#cf222e">INTO</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>Users<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">(</span>Id<span style="color:#1f2328">,</span>DisplayName<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#cf222e">Location</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>Reputation<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">VALUES</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0550ae">22656</span><span style="color:#1f2328">,</span><span style="color:#fff">	</span><span style="color:#0a3069">&#39;Jon Skeet&#39;</span><span style="color:#fff">	    </span><span style="color:#1f2328">,</span><span style="color:#0a3069">&#39;Reading, United Kingdom&#39;</span><span style="color:#fff">	    </span><span style="color:#1f2328">,</span><span style="color:#0550ae">1047863</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0550ae">22661</span><span style="color:#1f2328">,</span><span style="color:#fff">	</span><span style="color:#0a3069">&#39;Virne&#39;</span><span style="color:#fff">		    </span><span style="color:#1f2328">,</span><span style="color:#0a3069">&#39;Finland&#39;</span><span style="color:#fff">			            </span><span style="color:#1f2328">,</span><span style="color:#0550ae">1076</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0550ae">22668</span><span style="color:#1f2328">,</span><span style="color:#fff">	</span><span style="color:#0a3069">&#39;Dickon Reed&#39;</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#0a3069">&#39;Cambridge, United Kingdom&#39;</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#0550ae">2237</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">EXEC</span><span style="color:#fff"> </span>tSQLt<span style="color:#1f2328">.</span>FakeTable<span style="color:#fff"> </span><span style="color:#0a3069">&#39;dbo.Comments&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">INSERT</span><span style="color:#fff"> </span><span style="color:#cf222e">INTO</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>Comments<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">(</span>Id<span style="color:#1f2328">,</span><span style="color:#fff"> </span>UserId<span style="color:#1f2328">,</span>CreationDate<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">VALUES</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0550ae">436275</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">22661</span><span style="color:#fff"> </span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;2020-05-01 09:39:00.000&#39;</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0550ae">197827</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">22668</span><span style="color:#fff"> </span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;2024-09-26 16:35:51.177&#39;</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0550ae">37360</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">22656</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;2024-09-26 16:35:51.177&#39;</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0550ae">37585</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">22656</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;2025-01-26 16:35:17.310&#39;</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0550ae">36000</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">22656</span><span style="color:#fff">	</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;2022-08-26 19:21:42.357&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>Expected<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">(</span>DisplayName<span style="color:#fff"> </span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">100</span><span style="color:#1f2328">),</span><span style="color:#fff"> </span><span style="color:#cf222e">Location</span><span style="color:#fff"> </span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">200</span><span style="color:#1f2328">),</span>Reputation<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>CommentCount<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">TABLE</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>Actual<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">(</span>DisplayName<span style="color:#fff"> </span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">100</span><span style="color:#1f2328">),</span><span style="color:#fff"> </span><span style="color:#cf222e">Location</span><span style="color:#fff"> </span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">200</span><span style="color:#1f2328">),</span>Reputation<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>CommentCount<span style="color:#fff"> </span><span style="color:#6639ba">INT</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">INSERT</span><span style="color:#fff"> </span><span style="color:#cf222e">INTO</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>Expected<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">(</span>DisplayName<span style="color:#1f2328">,</span><span style="color:#cf222e">Location</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>Reputation<span style="color:#1f2328">,</span><span style="color:#fff"> </span>CommentCount<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">VALUES</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Jon Skeet&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff">	</span><span style="color:#0a3069">&#39;Reading, United Kingdom&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff">	</span><span style="color:#0550ae">1047863</span><span style="color:#1f2328">,</span><span style="color:#fff">	</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">/* ACT STAGE */</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">INSERT</span><span style="color:#fff"> </span><span style="color:#cf222e">INTO</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>Actual<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">EXEC</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>dbo<span style="color:#1f2328">].[</span>GetUserDetail_LastYear<span style="color:#1f2328">]</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span>DisplayName<span style="color:#fff">	</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;Jon Skeet&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#57606a">/* ASSERT STAGE */</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">EXEC</span><span style="color:#fff"> </span>tSQLt<span style="color:#1f2328">.</span>AssertEqualsTable<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span>Expected<span style="color:#fff">	</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;dbo.Expected&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span>Actual<span style="color:#fff">		</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;dbo.Actual&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span>FailMsg<span style="color:#fff">	</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;Our test failed!&#39;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">END</span><span style="color:#fff">
</span></span></span></code></pre></div><br>
<br>
<h3 id="the-importance-of-unit-test-isolation">The importance of Unit Test isolation</h3>
<p>So we have our updated procedure, which now contains that additional call to the procedure dbo.AddToAuditLog.
We also have our unit test to test the main procedure dbo.GetUserDetail_LastYear. Everyone keeping up? Goodo.</p>
<p>Currently, everything runs well, and we are validating the functionality of our main stored procedure, each time we run our unit test. Great. However, there is still a potential issue and I&rsquo;ll show you why.</p>
<p>Let&rsquo;s say that one day, somebody introduces a bug into our embedded procedure dbo.AddToAuditLog. (Zero changes are made to our main procedure)</p>
<p>Let us simulate that &lsquo;bug&rsquo; now within our embedded procedure. As shown below, we will simply add a RAISERROR to the procedure, dbo.AddToAuditLog:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">CREATE</span><span style="color:#fff"> </span><span style="color:#cf222e">OR</span><span style="color:#fff"> </span><span style="color:#cf222e">ALTER</span><span style="color:#fff"> </span><span style="color:#cf222e">PROCEDURE</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>dbo<span style="color:#1f2328">].[</span>AddToAuditLog<span style="color:#1f2328">]</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span>ProcName<span style="color:#fff">		</span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">100</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span>Who<span style="color:#fff">			</span>NVARCHAR<span style="color:#1f2328">(</span><span style="color:#0550ae">300</span><span style="color:#1f2328">),</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#0550ae">@</span><span style="color:#cf222e">When</span><span style="color:#fff">			</span>DATETIME<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">AS</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">BEGIN</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">INSERT</span><span style="color:#fff"> </span><span style="color:#cf222e">INTO</span><span style="color:#fff"> </span>dbo<span style="color:#1f2328">.</span>AuditLog<span style="color:#fff"> </span><span style="color:#1f2328">(</span>ProcName<span style="color:#1f2328">,</span>Who<span style="color:#1f2328">,[</span><span style="color:#cf222e">When</span><span style="color:#1f2328">])</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">VALUES</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#0550ae">@</span>ProcName<span style="color:#1f2328">,</span><span style="color:#0550ae">@</span>Who<span style="color:#1f2328">,</span><span style="color:#0550ae">@</span><span style="color:#cf222e">When</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#57606a">-- Our Fake Bug Here
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">	</span>RAISERROR<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;Fake Bug&#39;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">16</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">END</span><span style="color:#fff">
</span></span></span></code></pre></div><br>
<p>The next time we run our unsuspecting unit test, <strong>[tests].[test GetUserDetail_LastYear]</strong>, we will see this:</p>
<img src="/posts/post_images/messages_2.png" alt="tsqlt">
<p><em>Bug&rsquo;s Life</em></p>
<br>
<p>Our unit test has failed, and the culprit is our ‘fake bug’ within the embedded stored procedure.
Despite no changes being made to our main stored procedure or unit test, the test is now failing.
Naturally, this is far from ideal.
Consider a scenario where our main stored procedure interacts with numerous other stored procedures. With different development teams making frequent changes to these external dependencies, our unit test could break at any moment — despite the fact that the underlying procedure itself remains unchanged.</p>
<br>
<br>
<h3 id="the-spy-procedure">The Spy Procedure</h3>
<p>As we have shown, having unhandled dependencies to other objects is risky. Even though our main stored procedure and unit test remained the same, the unit test is now failing due to an &rsquo;external&rsquo; dependency on another stored procedure.</p>
<p>Thankfully the folks at tSQLt have a way to handle this. Enter the <a href="https://tsqlt.org/user-guide/isolating-dependencies/spyprocedure/">Spy Procedure</a>.</p>
<p>The Spy Procedure enables the creation of tests for a procedure while keeping it independent from the procedures it invokes.</p>
<br>
<p>From tSQLt.org</p>
<blockquote>
<p>To create independent tests, we can replace the functionality of a stored procedure with a spy. The spy will record the parameters that were passed to it.</p></blockquote>
<br>
<p>At its very basic functionality, Spy Procedure allows us to simply &lsquo;ignore&rsquo; a particular procedure call, and that&rsquo;s how we&rsquo;re going to utilise it today.</p>
<p>So, we&rsquo;re going to add the following line of code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">EXEC</span><span style="color:#fff"> </span>tSQLt<span style="color:#1f2328">.</span>SpyProcedure<span style="color:#fff"> </span><span style="color:#0550ae">@</span>ProcedureName<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;dbo.AddToAuditLog&#39;</span><span style="color:#fff">
</span></span></span></code></pre></div><p>This tells tSQLt to simply ignore any references (or calls), to our audit log procedure. As you can see below, we have added the Spy Procedure call within our Assemble stage:</p>
<img src="/posts/post_images/tsqlt_1.png" alt="tsqlt">
<br>
<br>
<br>
<p>The next time we execute our Unit Test, everything, once again, passes:</p>
<img src="/posts/post_images/tsqlt_2.png" alt="tsqlt">
<br>
<br>
<p>Spy Procedure has additional features, which include the ability to capture the parameter values passed into the intended procedure at the time. However, for our use case today, simply ignoring any calls to dbo.AddToAuditLog achieves what is needed. We are now confident that our unit test and stored procedure have been sufficiently isolated and have zero dependencies to external objects.</p>
<br>
<br>
<h3 id="recap">Recap</h3>
<p>In today&rsquo;s post, we have:</p>
<ul>
<li>Added an additional call to an external &lsquo;audit log&rsquo; procedure, within our main dbo.GetUserDetail_LastYear procedure</li>
<li>Verified that audit log information is being recorded when the procedure is called</li>
<li>Introduced a fake bug, into the audit procedure that is called within our main procedure</li>
<li>Witnessed the failure of our unit test, despite zero changes being made to dbo.GetUserDetail_LastYear and &rsquo;test GetUserDetail_LastYear&rsquo;</li>
<li>Utilised Spy Procedure to handle this external dependency on the Audit Log procedure to isolate our test / main procedure, to enable our test to pass again</li>
</ul>
<p>In the next post, we will continue with our tSQLt journey and look at some of the additional tooling available to help us streamline our test case scenarios</p>
<p>Thanks for reading!
<br>
<br>
<br></p>
<hr>
<p>If you’ve found this post helpful or would just like to support the work I do here, consider buying me a coffee.</p>
<p><a href="https://www.buymeacoffee.com/leebrownhill" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/arial-green.png" alt="Buy Me A Coffee" style="height: 55px !important;width: 217px !important;" ></a></p>
<br>
<br>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/sql/" rel="tag">sql</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/tsql/" rel="tag">tsql</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/unit-testing/" rel="tag">unit testing</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Lee Brownhill avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">Author: Lee Brownhill</span>
	</div>
	<div class="authorbox__description">
		Lee Brownhill is a SQL Server Professional. He enjoys making SQL Server go faster
	</div>
</div>



			</div>
			
		</div>
		<style>
  .footer__container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    text-align: left;
    font-size: 0.75rem;  
  }

  @media (max-width: 600px) {
    .footer__container {
      font-size: 0.60rem;  
    }
  }

  .footer__copyright {
    flex: 1;
  }

  .footer__privacy {
    text-align: right;
  }
</style>

<footer class="footer">
  <div class="container footer__container">
    <div class="footer__copyright">
      &copy; 2025 Lee Brownhill.
      <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
    </div>
    <div class="footer__privacy">
      <a href="/privacy-policy" rel="noopener noreferrer">Privacy Policy</a>
    </div>
  </div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>