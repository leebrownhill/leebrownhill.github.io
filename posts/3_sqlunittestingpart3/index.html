<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL Unit Testing Using tSQLt: Part 3 - Lee Brownhill&#39;s Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="A blog post about SQL Unit Testing with tSQLt. Covers a tSQLt example using code examples for stored procedure and unit test">
		<meta property="og:url" content="https://leebrownhill.github.io/posts/3_sqlunittestingpart3/">
  <meta property="og:site_name" content="Lee Brownhill&#39;s Blog">
  <meta property="og:title" content="SQL Unit Testing Using tSQLt: Part 3">
  <meta property="og:description" content="A blog post about SQL Unit Testing with tSQLt. Covers a tSQLt example using code examples for stored procedure and unit test">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-23T06:00:00+00:00">
    <meta property="article:modified_time" content="2025-04-23T06:00:00+00:00">
    <meta property="article:tag" content="Sql">
    <meta property="article:tag" content="Tsql">
    <meta property="article:tag" content="Unit Testing">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
		
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7983PDFMXQ"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7983PDFMXQ');
        }
      </script>

	<meta name="author" content="Lee Brownhill">
	<meta property="og:description" content="A blog post about SQL Unit Testing with tSQLt. Covers a tSQLt example using code examples for stored procedure and unit test">
	<meta property="og:image" content="https://leebrownhill.github.io/">
	<meta property="og:image:type" content="img/png">

	






	

	<script src="/js/clarity.js"></script>
	<script src="/js/ads.js"></script>




	
	




</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	

	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="Lee Brownhill&#39;s Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/avatar.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">Lee Brownhill&#39;s Blog</div>
					<div class="logo__tagline">A blog about SQL Server, mostly</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">blog</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/talks">
				
				<span class="menu__text">talks</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about">
				
				<span class="menu__text">about</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/contact">
				
				<span class="menu__text">contact</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>


	
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL Unit Testing Using tSQLt: Part 3</h1>
			
		</header>
		<div class="content post__content clearfix">
			<br>
<p>The Journey Continues!</p>
<p>Welcome back to the <a href="https://www.leebrownhill.com/tags/tsql/">tSQLt series</a>, where we are covering the fundamentals of Unit Testing within SQL Server by using the tSQLt Framework.</p>
<p>Today we&rsquo;re progressing onward by discussing some of the useful features within tSQLt to ensure our tests are accurate, reliable, and repeatable.</p>
<p>In the <a href="https://www.leebrownhill.com/posts/2_sqlunittestingpart2/">last post</a>, we went through the process of creating a basic tSQLt test.  We covered the basic constructs of generating a unit test by implementing the three stages of a test:</p>
<ol>
<li>Assemble</li>
<li>Act</li>
<li>Assert</li>
</ol>
<p>Within the Assemble stage, we made use of the <a href="https://tsqlt.org/user-guide/isolating-dependencies/faketable/">Fake Table</a> function, which allowed us to create a &lsquo;faked&rsquo; version of a table. Such functionality is a core pillar of unit testing with tSQLt. Our unit tests should be isolated and idempotent mechanisms.</p>
<p>The Fake Table function is just one of the many tools in our arsenal when using tSQLt, and I wanted to take some time in this post to cover another feature which will be useful to us - the <strong>Fake Function</strong> function.
More official documentation about it here - <a href="https://tsqlt.org/user-guide/isolating-dependencies/fakefunction/">Fake Function</a></p>
<p>From <a href="https://tsqlt.org/user-guide/isolating-dependencies/fakefunction/">tSQLt.org</a>:</p>
<blockquote>
<p><em>Code that calls a function can be difficult to test if that function performs significant logic. We want to isolate the code we are testing from the logic buried in the functions that it calls. To create independent tests, we can replace a called function with a fake function. The fake function will perform much simpler logic that supports the purpose of our test. Often, the fake function will simply return a hard-coded value.</em></p>
</blockquote>
<br>
<p>In this post, we are going to walk through a demo to illustrate the following:</p>
<ul>
<li>The underlying procedure being tested</li>
<li>The Unit Test, which will test the underlying procedure</li>
<li>The implementation of the Fake Function feature</li>
</ul>
<br>
<h3 id="setting-the-scene---the-procedure-to-be-tested">Setting the Scene - The procedure to be tested</h3>
<p>We have an updated procedure, from our last post,  called - GetUserDetail_LastYear</p>
<p>The key things this procedure does:</p>
<ul>
<li>Takes in one input parameter called @DisplayName</li>
<li>Retrieves information about the passed-in user, for the past year, based on the time the procedure is run (<em>take note of this, trusted reader</em>)</li>
</ul>
<p>Once again, we&rsquo;re going to be using the <a href="https://www.brentozar.com/archive/2015/10/how-to-download-the-stack-overflow-database-via-bittorrent/">Stack Overflow database</a>. Here is the full procedure:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">CREATE</span> <span style="color:#719e07">OR</span> <span style="color:#719e07">ALTER</span> <span style="color:#719e07">PROCEDURE</span> [dbo].[GetUserDetail_LastYear]
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">@</span>DisplayName NVARCHAR(<span style="color:#2aa198">100</span>)
</span></span><span style="display:flex;"><span><span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">BEGIN</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">DECLARE</span> <span style="color:#719e07">@</span>Now            DATETIME
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">DECLARE</span> <span style="color:#719e07">@</span>OneYearAgo     DATETIME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SET</span> <span style="color:#719e07">@</span>Now                <span style="color:#719e07">=</span> dbo.DateTimeNow()
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SET</span> <span style="color:#719e07">@</span>OneYearAgo         <span style="color:#719e07">=</span> DATEADD(<span style="color:#719e07">YEAR</span>, <span style="color:#719e07">-</span><span style="color:#2aa198">1</span>, <span style="color:#719e07">@</span>Now)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SELECT</span>
</span></span><span style="display:flex;"><span>        u.DisplayName,
</span></span><span style="display:flex;"><span>        u.<span style="color:#719e07">Location</span>,
</span></span><span style="display:flex;"><span>        u.Reputation,
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">COUNT</span>(<span style="color:#719e07">c</span>.Id) <span style="color:#719e07">AS</span> CommentCount
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">FROM</span> dbo.Users u
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">INNER</span> <span style="color:#719e07">JOIN</span> dbo.Comments <span style="color:#719e07">c</span> <span style="color:#719e07">ON</span> u.Id <span style="color:#719e07">=</span> <span style="color:#719e07">c</span>.UserId
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">WHERE</span> 
</span></span><span style="display:flex;"><span>        u.DisplayName <span style="color:#719e07">=</span> <span style="color:#719e07">@</span>DisplayName <span style="color:#719e07">AND</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#719e07">c</span>.CreationDate <span style="color:#719e07">BETWEEN</span> <span style="color:#719e07">@</span>OneYearAgo <span style="color:#719e07">AND</span> <span style="color:#719e07">@</span>Now
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">GROUP</span> <span style="color:#719e07">BY</span> u.DisplayName, u.<span style="color:#719e07">Location</span>, u.Reputation
</span></span><span style="display:flex;"><span><span style="color:#719e07">END</span>
</span></span></code></pre></div><p>Calling the procedure for a particular user renders the following detail:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> dbo.GetUserDetail_LastYear <span style="color:#719e07">@</span>DisplayName <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Jon Skeet&#39;</span>
</span></span></code></pre></div><br>
<img src="/posts/post_images/results_1.png" alt="tsqlt">
<br>
<br>
<br>
<br>
<h3 id="setting-the-scene---the-unit-test">Setting the Scene - The Unit Test</h3>
<p>Following the same methodology used in the last post, we have created a unit test for dbo.GetUserDetail_LastYear.</p>
<p>Here is the full unit test, we will discuss it in more detail later:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">CREATE</span> <span style="color:#719e07">OR</span> <span style="color:#719e07">ALTER</span> <span style="color:#719e07">PROCEDURE</span> [tests].[test GetUserDetail_LastYear]
</span></span><span style="display:flex;"><span><span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">BEGIN</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">DECLARE</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">@</span>UserName NVARCHAR(<span style="color:#2aa198">100</span>)	<span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Jon Skeet&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/* ASSEMBLE STAGE */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> tSQLt.FakeTable <span style="color:#2aa198">&#39;dbo.Users&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> dbo.Users
</span></span><span style="display:flex;"><span>(Id,DisplayName, <span style="color:#719e07">Location</span>, Reputation)
</span></span><span style="display:flex;"><span><span style="color:#719e07">VALUES</span>
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">22656</span>,	<span style="color:#2aa198">&#39;Jon Skeet&#39;</span>		,<span style="color:#2aa198">&#39;Reading, United Kingdom&#39;</span>		,<span style="color:#2aa198">1047863</span>),
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">22661</span>,	<span style="color:#2aa198">&#39;Virne&#39;</span>			,<span style="color:#2aa198">&#39;Finland&#39;</span>						,<span style="color:#2aa198">1076</span>),
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">22668</span>,	<span style="color:#2aa198">&#39;Dickon Reed&#39;</span>	,<span style="color:#2aa198">&#39;Cambridge, United Kingdom&#39;</span>	,<span style="color:#2aa198">2237</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> tSQLt.FakeTable <span style="color:#2aa198">&#39;dbo.Comments&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> dbo.Comments
</span></span><span style="display:flex;"><span>(Id, UserId,CreationDate)
</span></span><span style="display:flex;"><span><span style="color:#719e07">VALUES</span>
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">436275</span>	, <span style="color:#2aa198">22661</span> , <span style="color:#2aa198">&#39;2020-05-01 09:39:00.000&#39;</span>),
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">197827</span>	, <span style="color:#2aa198">22668</span> , <span style="color:#2aa198">&#39;2024-09-26 16:35:51.177&#39;</span>),
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">37360</span>	, <span style="color:#2aa198">22656</span>	, <span style="color:#2aa198">&#39;2024-09-26 16:35:51.177&#39;</span>),
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">37585</span>	, <span style="color:#2aa198">22656</span>	, <span style="color:#2aa198">&#39;2025-01-26 16:35:17.310&#39;</span>),
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">36000</span>	, <span style="color:#2aa198">22656</span>	, <span style="color:#2aa198">&#39;2022-08-26 19:21:42.357&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">CREATE</span> <span style="color:#719e07">TABLE</span> dbo.Expected
</span></span><span style="display:flex;"><span>(DisplayName NVARCHAR(<span style="color:#2aa198">100</span>), <span style="color:#719e07">Location</span> NVARCHAR(<span style="color:#2aa198">200</span>),Reputation <span style="color:#b58900">INT</span>, CommentCount <span style="color:#b58900">INT</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">CREATE</span> <span style="color:#719e07">TABLE</span> dbo.Actual
</span></span><span style="display:flex;"><span>(DisplayName NVARCHAR(<span style="color:#2aa198">100</span>), <span style="color:#719e07">Location</span> NVARCHAR(<span style="color:#2aa198">200</span>),Reputation <span style="color:#b58900">INT</span>, CommentCount <span style="color:#b58900">INT</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> dbo.Expected
</span></span><span style="display:flex;"><span>(DisplayName,<span style="color:#719e07">Location</span>, Reputation, CommentCount)
</span></span><span style="display:flex;"><span><span style="color:#719e07">VALUES</span>
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">&#39;Jon Skeet&#39;</span>,	<span style="color:#2aa198">&#39;Reading, United Kingdom&#39;</span>,	<span style="color:#2aa198">1047863</span>,	<span style="color:#2aa198">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/* ACT STAGE */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> dbo.Actual
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> [dbo].[GetUserDetail_LastYear] 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">@</span>DisplayName	<span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Jon Skeet&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/* ASSERT STAGE */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> tSQLt.AssertEqualsTable
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">@</span>Expected	<span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;dbo.Expected&#39;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">@</span>Actual		<span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;dbo.Actual&#39;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">@</span>FailMsg	<span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Our test failed!&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">END</span>
</span></span></code></pre></div><p>So we now have our underlying stored procedure, we also have our associated unit test. If we call our test:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> tSQLt.Run <span style="color:#719e07">@</span>TestName <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;[tests].[test GetUserDetail_LastYear]&#39;</span>
</span></span></code></pre></div><p>The test passes, as expected:</p>
<img src="/posts/post_images/messages_1.png" alt="tsqlt">
<br>
<br>
<p>All is well, the test passes and our work here is done. Right?</p>
<br>
<p>WRONG.</p>
<img src="/posts/post_images/meme_1.png" alt="cavill_meme" style="width:320px; height:auto;">
<br>
<br>
<br>
<br>
<h3 id="issue-1-the-date-function-used">Issue 1: The Date Function Used</h3>
<p>Currently, if we run our new unit test, it runs without issue, for &lsquo;<strong>today</strong>&rsquo;. The eagle-eyed readers may have noticed something within our main stored procedure.</p>
<p>Within our stored procedure, we have the following function being used:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">SET</span> <span style="color:#719e07">@</span>Now <span style="color:#719e07">=</span> dbo.DateTimeNow()
</span></span></code></pre></div><p>This function is calculating the date and time when the procedure is executed.
We have written our unit test to calculate the results to accommodate this, for &rsquo;today&rsquo;.
<br>But what happens if we run it tomorrow? Next week? You guessed it, our test will fail because the date will obviously be different, and so will our date range that&rsquo;s being used as a filter.
We are currently expecting a comment count of 2 to come back, based on the date the test is executed (today). This will obviously change over time and so, cannot be sure that our unit test will continue to pass.</p>
<p>Thankfully, the good folks over at tSQLt have thought of this and have a useful function for us to handle these scenarios. That function is the <a href="https://tsqlt.org/user-guide/isolating-dependencies/fakefunction/">Fake Function</a>.</p>
<br>
<h3 id="solution-1-the-fake-function">Solution 1: The Fake Function</h3>
<p>The Fake Function option allows us to tell tSQLt that whenever it encounters a particular function, it should ignore it and use something else.
The &lsquo;something else&rsquo; is where we can step in and become empowered to handle this scenario.</p>
<p>We will add the following to our unit test code, within the &ldquo;Assemble&rdquo; section:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> tSQLt.FakeFunction <span style="color:#719e07">@</span>FunctionName <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;dbo.DateTimeNow&#39;</span>, <span style="color:#719e07">@</span>FakeFunctionName <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Fake.DateTimeNow&#39;</span>
</span></span></code></pre></div><p>As above, we are calling the Fake Function option to say whenever we encounter the function dbo.DateTimeNow, that we should actually use the function &lsquo;Fake.DateTimeNow&rsquo; instead.</p>
<p>This allows us to use a &lsquo;faked&rsquo; version of the function. Here is our faked version:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">CREATE</span> <span style="color:#719e07">OR</span> <span style="color:#719e07">ALTER</span> <span style="color:#719e07">FUNCTION</span> [Fake].[DateTimeNow]()
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">RETURNS</span> DATETIME
</span></span><span style="display:flex;"><span><span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">RETURN</span> <span style="color:#2aa198">&#39;2025-04-11 00:00:00.000&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">END</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">GO</span>
</span></span></code></pre></div><p>This version simply returns a static datetime which is perfect for us to be able to generate a repeatable method for interrogating the data when running our unit test.</p>
<p>This is ideal, as our focus isn&rsquo;t on testing the underlying functionality of the dbo.DateTimeNow function at this stage.
We are only concerned with the isolated test of the stored procedure dbo.GetUserDetail_LastYear. We can now be confident that whenever our unit test is executed, it&rsquo;s always going to use the same date to interrogate the data.</p>
<p>Should we need to, we can create a dedicated unit test for the actual function at a later date, in isolation.</p>
<p>Our updated unit test, now begins like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">CREATE</span> <span style="color:#719e07">OR</span> <span style="color:#719e07">ALTER</span> <span style="color:#719e07">PROCEDURE</span> [tests].[test GetUserDetail_LastYear]
</span></span><span style="display:flex;"><span><span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">BEGIN</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">DECLARE</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">@</span>UserName NVARCHAR(<span style="color:#2aa198">100</span>)	<span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Jon Skeet&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/* ASSEMBLE STAGE */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> tSQLt.FakeFunction <span style="color:#719e07">@</span>FunctionName <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;dbo.DateTimeNow&#39;</span>, <span style="color:#719e07">@</span>FakeFunctionName <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Fake.DateTimeNow&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">EXEC</span> tSQLt.FakeTable <span style="color:#2aa198">&#39;dbo.Users&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> dbo.Users
</span></span><span style="display:flex;"><span>(Id,DisplayName, <span style="color:#719e07">Location</span>, Reputation)
</span></span><span style="display:flex;"><span><span style="color:#719e07">VALUES</span>
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">22656</span>,	<span style="color:#2aa198">&#39;Jon Skeet&#39;</span>	,<span style="color:#2aa198">&#39;Reading, United Kingdom&#39;</span>	,<span style="color:#2aa198">1047863</span>),
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">22661</span>,	<span style="color:#2aa198">&#39;Virne&#39;</span>		,<span style="color:#2aa198">&#39;Finland&#39;</span>			,<span style="color:#2aa198">1076</span>),
</span></span><span style="display:flex;"><span>	(<span style="color:#2aa198">22668</span>,	<span style="color:#2aa198">&#39;Dickon Reed&#39;</span>	,<span style="color:#2aa198">&#39;Cambridge, United Kingdom&#39;</span>	,<span style="color:#2aa198">2237</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/* TRUNCATED FOR BREVITY */</span>
</span></span></code></pre></div><br>
<p>I hope you enjoyed this post that covered the Fake Function option of tSQLt. Once again, this is just one of many useful tools we can access when using the tSQLt framework. There are many more which we will continue to cover in the next post in the series.
Speaking of which, next up, we will cover &lsquo;Spy Procedure&rsquo; feature of tSQLt. I hope to see you there.</p>
<p>Thanks for reading.
<br>
<br>
<br></p>
<hr>
<p>If youâ€™ve found this post helpful or would just like to support the work I do here, consider buying me a coffee.</p>
<p><a href="https://www.buymeacoffee.com/leebrownhill" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/arial-green.png" alt="Buy Me A Coffee" style="height: 55px !important;width: 217px !important;" ></a></p>
<br>
<br>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/sql/" rel="tag">sql</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/tsql/" rel="tag">tsql</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/unit-testing/" rel="tag">unit testing</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Lee Brownhill avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">Author: Lee Brownhill</span>
	</div>
	<div class="authorbox__description">
		Lee Brownhill is a SQL Server Professional. He enjoys making SQL Server go faster
	</div>
</div>



			</div>
			
		</div>
		<style>
  .footer__container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    text-align: left;
    font-size: 0.75rem;  
  }

  @media (max-width: 600px) {
    .footer__container {
      font-size: 0.60rem;  
    }
  }

  .footer__copyright {
    flex: 1;
  }

  .footer__privacy {
    text-align: right;
  }
</style>

<footer class="footer">
  <div class="container footer__container">
    <div class="footer__copyright">
      &copy; 2025 Lee Brownhill.
      <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
    </div>
    <div class="footer__privacy">
      <a href="/privacy-policy" rel="noopener noreferrer">Privacy Policy</a>
    </div>
  </div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>