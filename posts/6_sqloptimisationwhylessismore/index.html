<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL Server Optimisation: Why Less Is More - Lee Brownhill&#39;s Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="A blog post discussing the merits of minimising your SQL Server code to improve not only readability but also performance">
		<meta property="og:url" content="https://leebrownhill.github.io/posts/6_sqloptimisationwhylessismore/">
  <meta property="og:site_name" content="Lee Brownhill&#39;s Blog">
  <meta property="og:title" content="SQL Server Optimisation: Why Less Is More">
  <meta property="og:description" content="A blog post discussing the merits of minimising your SQL Server code to improve not only readability but also performance">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-19T05:00:00+00:00">
    <meta property="article:modified_time" content="2025-05-19T05:00:00+00:00">
    <meta property="article:tag" content="Sql">
    <meta property="article:tag" content="Optimisation">
    <meta property="article:tag" content="Performance Tuning">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
		
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7983PDFMXQ"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7983PDFMXQ');
        }
      </script>

	<meta name="author" content="Lee Brownhill">
	<meta property="og:description" content="A blog post discussing the merits of minimising your SQL Server code to improve not only readability but also performance">
	<meta property="og:image" content="https://leebrownhill.github.io/img/featured/less_is_more3.png">
	<meta property="og:image:type" content="img/png">

	






	

	<script src="/js/clarity.js"></script>
	<script src="/js/ads.js"></script>




	
	




</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	

	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="Lee Brownhill&#39;s Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/avatar.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">Lee Brownhill&#39;s Blog</div>
					<div class="logo__tagline">A blog about SQL Server, mostly</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">blog</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/talks">
				
				<span class="menu__text">talks</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about">
				
				<span class="menu__text">about</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/contact">
				
				<span class="menu__text">contact</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>


	
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL Server Optimisation: Why Less Is More</h1>
			
		</header>
		<div class="content post__content clearfix">
			<br>
<p>One of the most valuable lessons I&rsquo;ve learned in performance tuning is the importance of breaking queries tasks into smaller, more manageable sections.
Who knew? The experts were right all along when they said, &ldquo;If you&rsquo;re confused by the query, SQL probably is too&rdquo;.</p>
<p>In today&rsquo;s post, we will cover a simple, but powerful concept when trying to write queries.
A common sight as a DBA is long, monolithic queries attempting to do ALL THE THINGS in one pass (including solving world peace, all powered by a table variable). <br>
Joking aside, the longer and more complex a query is, the greater the chance of issues arising, especially as the database grows over time. That 10,000 line stored procedure may run fine in the early days when you have 100 records in each table. However, it won&rsquo;t last.</p>
<br>
<h3 id="predicting-the-future">Predicting The Future</h3>
<p>One thing that happens when you execute a query in SQL Server is that SQL quickly determines the optimal execution plan for your query. At this point, things can go wrong with large, complex queries.
SQL must estimate multiple factors, including how many records pass through the query at different stages of dataset processing. The more datasets being rendered, the more logic there is, the more complex the joins; the more pushed SQL is going to be for making good judgement calls within that tiny window of time.</p>
<br>
<h3 id="divide-and-conquer">Divide And Conquer</h3>
<p>Fear not, intrepid reader - we can assist SQL in making smarter decisions. There is a concept which can help us here called &lsquo;materialising&rsquo; datasets.
We can take an approach that guides SQL as it rapidly makes judgement calls about retrieving the tables and columns youâ€™ve joined.
Minimising the number of rows we need to work with as quickly as possible, as early as possible, can have significant effects on your query&rsquo;s performance.</p>
<br>
<h3 id="demo-setting-the-stage">Demo: Setting The Stage</h3>
<p>Lets do a demo to show what I mean. I will be using:</p>
<ul>
<li>SQL Server 2022</li>
<li>StackOverflow2013 database, in compatibility level 160</li>
</ul>
<p>Here we have an ugly query, it&rsquo;s joining up dataset to dataset, adding various conditional logic along the way too.
Reading this type of query hurts, but I am trying to make a point here, and it&rsquo;s not &rsquo;that&rsquo; different to what I will commonly see out in the wild.
You don&rsquo;t need to understand it all -  you don&rsquo;t even need to read it all. I just want you to be mindful of the number of joins, hops, spins arounds and touch the grounds we are doing throughout it.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE StackOverflow2013;
</span></span><span style="display:flex;"><span><span style="color:#719e07">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">DROP</span> <span style="color:#719e07">TABLE</span> <span style="color:#719e07">IF</span> <span style="color:#719e07">EXISTS</span> <span style="color:#719e07">#</span>GetQuestionAndAnswers;
</span></span><span style="display:flex;"><span><span style="color:#719e07">DROP</span> <span style="color:#719e07">TABLE</span> <span style="color:#719e07">IF</span> <span style="color:#719e07">EXISTS</span> <span style="color:#719e07">#</span>GetQuestionAndAnswers2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;<span style="color:#719e07">WITH</span> GetQuestions <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#2aa198">&#39;Question&#39;</span> <span style="color:#719e07">AS</span> Q,
</span></span><span style="display:flex;"><span>		p.Title,
</span></span><span style="display:flex;"><span>		p.OwnerUserId
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> dbo.Posts p
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">WHERE</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">AND</span> <span style="color:#719e07">EXISTS</span> (<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">FROM</span> dbo.Users u <span style="color:#719e07">WHERE</span> p.OwnerUserId <span style="color:#719e07">=</span> u.Id <span style="color:#719e07">AND</span> u.WebsiteUrl <span style="color:#719e07">&lt;&gt;</span> <span style="color:#2aa198">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>GetAnswers <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#2aa198">&#39;Answer&#39;</span> <span style="color:#719e07">AS</span> A,
</span></span><span style="display:flex;"><span>		p.Title,
</span></span><span style="display:flex;"><span>		p.OwnerUserId
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> dbo.Posts p
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">WHERE</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">AND</span> <span style="color:#719e07">EXISTS</span> (<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">FROM</span> dbo.Users u <span style="color:#719e07">WHERE</span> p.OwnerUserId <span style="color:#719e07">=</span> u.Id <span style="color:#719e07">AND</span> u.WebsiteUrl <span style="color:#719e07">&lt;&gt;</span> <span style="color:#2aa198">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>GetQuestionAndAnswers <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		GetQuestions.Q,
</span></span><span style="display:flex;"><span>		GetQuestions.Title,
</span></span><span style="display:flex;"><span>		GetQuestions.OwnerUserId 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> GetQuestions
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">UNION</span> <span style="color:#719e07">ALL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		GetAnswers.A,
</span></span><span style="display:flex;"><span>		GetAnswers.Title,
</span></span><span style="display:flex;"><span>		GetAnswers.OwnerUserId 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> GetAnswers
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">SELECT</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> qa.Q <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Question&#39;</span> <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalQuestions,
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> qa.Q <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Answer&#39;</span>	<span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalAnswers
</span></span><span style="display:flex;"><span><span style="color:#719e07">INTO</span> <span style="color:#719e07">#</span>GetQuestionAndAnswers
</span></span><span style="display:flex;"><span><span style="color:#719e07">FROM</span> GetQuestionAndAnswers qa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;<span style="color:#719e07">WITH</span> GetQuestions2 <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#2aa198">&#39;Question&#39;</span> <span style="color:#719e07">AS</span> Q,
</span></span><span style="display:flex;"><span>		p.Title,
</span></span><span style="display:flex;"><span>		p.OwnerUserId
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> dbo.Posts p
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">WHERE</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">AND</span> <span style="color:#719e07">EXISTS</span> (<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">FROM</span> dbo.Users u <span style="color:#719e07">WHERE</span> p.OwnerUserId <span style="color:#719e07">=</span> u.Id <span style="color:#719e07">AND</span> u.WebsiteUrl <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>GetAnswers2 <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#2aa198">&#39;Answer&#39;</span> <span style="color:#719e07">AS</span> A,
</span></span><span style="display:flex;"><span>		p.Title,
</span></span><span style="display:flex;"><span>		p.OwnerUserId
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> dbo.Posts p
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">WHERE</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">AND</span> <span style="color:#719e07">EXISTS</span> (<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">FROM</span> dbo.Users u <span style="color:#719e07">WHERE</span> p.OwnerUserId <span style="color:#719e07">=</span> u.Id <span style="color:#719e07">AND</span> u.WebsiteUrl <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>GetQuestionAndAnswers2 <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		GetQuestions2.Q,
</span></span><span style="display:flex;"><span>		GetQuestions2.Title,
</span></span><span style="display:flex;"><span>		GetQuestions2.OwnerUserId 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> GetQuestions2
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">UNION</span> <span style="color:#719e07">ALL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		GetAnswers2.A,
</span></span><span style="display:flex;"><span>		GetAnswers2.Title,
</span></span><span style="display:flex;"><span>		GetAnswers2.OwnerUserId 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> GetAnswers2
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">SELECT</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> qa.Q <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Question&#39;</span> <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalQuestions,
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> qa.Q <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Answer&#39;</span>	<span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalAnswers
</span></span><span style="display:flex;"><span><span style="color:#719e07">INTO</span> <span style="color:#719e07">#</span>GetQuestionAndAnswers2
</span></span><span style="display:flex;"><span><span style="color:#719e07">FROM</span> GetQuestionAndAnswers2 qa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;<span style="color:#719e07">WITH</span> AllTogether <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">&#39;Users With Website&#39;</span> <span style="color:#719e07">AS</span> [Category], 		<span style="color:#719e07">*</span> <span style="color:#719e07">FROM</span> <span style="color:#719e07">#</span>GetQuestionAndAnswers
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">UNION</span> <span style="color:#719e07">ALL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">&#39;Users Without Website&#39;</span> <span style="color:#719e07">AS</span> [Category], 	<span style="color:#719e07">*</span> <span style="color:#719e07">FROM</span> <span style="color:#719e07">#</span>GetQuestionAndAnswers2
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">MAX</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> Category <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Users With Website&#39;</span>		<span style="color:#719e07">THEN</span> TotalQuestions <span style="color:#719e07">END</span>)	<span style="color:#719e07">AS</span> TotalQuestionsWithURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">MAX</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> Category <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Users With Website&#39;</span>		<span style="color:#719e07">THEN</span> TotalAnswers <span style="color:#719e07">END</span>)		<span style="color:#719e07">AS</span> TotalAnswersWithURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">MAX</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> Category <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Users Without Website&#39;</span>	<span style="color:#719e07">THEN</span> TotalQuestions <span style="color:#719e07">END</span>)	<span style="color:#719e07">AS</span> TotalQuestionWithoutURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">MAX</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> Category <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Users Without Website&#39;</span>	<span style="color:#719e07">THEN</span> TotalAnswers <span style="color:#719e07">END</span>)		<span style="color:#719e07">AS</span> TotalAnswersWithoutURL
</span></span><span style="display:flex;"><span><span style="color:#719e07">FROM</span> AllTogether a;
</span></span></code></pre></div><br>
<h3 id="demo-we-can-do-better">Demo: We Can Do Better</h3>
<p>As you have seen, we have a long messy query which utilises all the things along the way.</p>
<p>When tackling a query like this, I try to apply the following strategies:</p>
<ul>
<li>Identify logical breaking points within the dataset rendering process: Think about how I can spoon-feed SQL information (food?) along the way. Can we try and â€˜materialiseâ€™ any datasets early in the logical processing of the query? My primary goal here is to shore up the estimates as early as possible. Better estimates mean better-resourced queries, which means better performance.</li>
<li>Look for repeated work or the repeated accessing of objects: The old adage is correct: <em>the fastest query is the one you don&rsquo;t run</em>. Too often I will see queries hitting the same table, several times in different ways when just one pass of the object would have done.</li>
</ul>
<p>Within the mess that is our demo query above, there are two aspects which I would like to address:</p>
<br>
<h4 id="1-accessing-the-dbousers-table---many-times">1 Accessing the dbo.Users table - many times</h4>
<p>We are repeatedly accessing the dbo.Users table to check that if corresponding post has a user with or without a website:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#586e75">-- Example 1
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#719e07">AND</span> <span style="color:#719e07">EXISTS</span> (<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">FROM</span> dbo.Users u <span style="color:#719e07">WHERE</span> p.OwnerUserId <span style="color:#719e07">=</span> u.Id <span style="color:#719e07">AND</span> u.WebsiteUrl <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">-- Example 2
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#719e07">AND</span> <span style="color:#719e07">EXISTS</span> (<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">FROM</span> dbo.Users u <span style="color:#719e07">WHERE</span> p.OwnerUserId <span style="color:#719e07">=</span> u.Id <span style="color:#719e07">AND</span> u.WebsiteUrl <span style="color:#719e07">&lt;&gt;</span> <span style="color:#2aa198">&#39;&#39;</span>)
</span></span></code></pre></div><p>Sure, I have amplified this aspect of the query somewhat for demonstration purposes. But it&rsquo;s not that dissimilar to the things I will often see out in the wild. I understand how it can easily happen too. You have time-pushed, stressed developers, tacking on things over time and you end up with unnecessary work being done.</p>
<p>So how do we correct this issue? We &lsquo;materialise&rsquo; a dataset early on within the query. Instead of querying the dbo.Users table four times, all we need to do is this, <em><strong>once</strong></em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> <span style="color:#719e07">#</span>UserDetail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>    u.Id,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> u.WebsiteUrl <span style="color:#719e07">&lt;&gt;</span> <span style="color:#2aa198">&#39;&#39;</span> <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span> <span style="color:#719e07">AS</span> WebExists,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> u.WebsiteUrl <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;&#39;</span>  <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span> <span style="color:#719e07">AS</span> WebDoesNotExist
</span></span><span style="display:flex;"><span><span style="color:#719e07">FROM</span> dbo.Users u;
</span></span></code></pre></div><p>We are materialising the dataset into a Temporary Table. This is a simple but important concept because:</p>
<ul>
<li>We only need to access the dbo.Users table once. One pass through it, and we have everything we need for the rest of the query</li>
<li>Materialising the dataset into a temporary table instead of using a Common Table Expression (CTE), for example, is key. This gives us a dataset which is &lsquo;static&rsquo; and does not need to be rendered each time it&rsquo;s called. Statistics are also used with temporary objects which will further aid SQL to make better judgement calls when allocating resource, as it should have a decent idea of how many records the temporary table holds.</li>
<li>We could even index the temporary table, should we need to.</li>
</ul>
<br>
<h4 id="2-rendering-the-dboposts-data---all-the-ways-all-the-time">2 Rendering the dbo.Posts data - all the ways, all the time</h4>
<p>In a similar vein to the issue with the Users table, we are rendering information from the dbo.Posts table. We have multiple CTEs rendering Posts information, based on whether it&rsquo;s a question or answer.
Further down, we reassemble this collected information using a UNION to bring the multiple datasets back together.</p>
<p><strong>Issue 1 : Repeated dataset renders for questions and answers</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#586e75">-- Example 1
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#719e07">WITH</span> GetQuestions <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#2aa198">&#39;Question&#39;</span> <span style="color:#719e07">AS</span> Q,
</span></span><span style="display:flex;"><span>		p.Title,
</span></span><span style="display:flex;"><span>		p.OwnerUserId
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> dbo.Posts p
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">WHERE</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">AND</span> <span style="color:#719e07">EXISTS</span> (<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">FROM</span> dbo.Users u <span style="color:#719e07">WHERE</span> p.OwnerUserId <span style="color:#719e07">=</span> u.Id <span style="color:#719e07">AND</span> u.WebsiteUrl <span style="color:#719e07">&lt;&gt;</span> <span style="color:#2aa198">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">-- Example 2
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>GetAnswers <span style="color:#719e07">AS</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#2aa198">&#39;Answer&#39;</span> <span style="color:#719e07">AS</span> A,
</span></span><span style="display:flex;"><span>		p.Title,
</span></span><span style="display:flex;"><span>		p.OwnerUserId
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> dbo.Posts p
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">WHERE</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">AND</span> <span style="color:#719e07">EXISTS</span> (<span style="color:#719e07">SELECT</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">FROM</span> dbo.Users u <span style="color:#719e07">WHERE</span> p.OwnerUserId <span style="color:#719e07">=</span> u.Id <span style="color:#719e07">AND</span> u.WebsiteUrl <span style="color:#719e07">&lt;&gt;</span> <span style="color:#2aa198">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>Issue 2 : Unnecessary dataset combining</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		GetQuestions.Q,
</span></span><span style="display:flex;"><span>		GetQuestions.Title,
</span></span><span style="display:flex;"><span>		GetQuestions.OwnerUserId 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> GetQuestions
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">UNION</span> <span style="color:#719e07">ALL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>		GetAnswers.A,
</span></span><span style="display:flex;"><span>		GetAnswers.Title,
</span></span><span style="display:flex;"><span>		GetAnswers.OwnerUserId 
</span></span><span style="display:flex;"><span>	<span style="color:#719e07">FROM</span> GetAnswers
</span></span></code></pre></div><p>Once again, I have been a scamp here and have overdone it slightly to prove a point.
However, it&rsquo;s really not uncommon to see this type of process in the real world. I have often stared at my screen, reviewing somebody&rsquo;s code, thinking &ldquo;But&hellip;why?&rdquo;
(<em>More worryingly, sometimes I realise it&rsquo;s my own code</em>)</p>
<p>Despite having those six CTEs (each rendering information from the dbo.Posts table) all we ultimately need to get the same output is the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">AND</span> u.WebExists <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalQuestionsWithURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span> <span style="color:#719e07">AND</span> u.WebExists <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalAnswersWithURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">AND</span> u.WebDoesNotExist <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalQuestionWithoutURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span> <span style="color:#719e07">AND</span> u.WebDoesNotExist <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalAnswersWithoutURL
</span></span><span style="display:flex;"><span><span style="color:#719e07">FROM</span> dbo.Posts p
</span></span><span style="display:flex;"><span><span style="color:#719e07">INNER</span> <span style="color:#719e07">JOIN</span> <span style="color:#719e07">#</span>UserDetail u <span style="color:#719e07">ON</span> p.OwnerUserId <span style="color:#719e07">=</span> u.UserId
</span></span></code></pre></div><p>Key points about the above:</p>
<ul>
<li>We are able to make one pass of the dbo.Posts table</li>
<li>Using logic (the CASE statements), we can simply get the status of the Post (question or answer) and SUM it accordingly</li>
<li>We have finally joined against the temporary table #UserDetail</li>
</ul>
<p>By rewriting the original query, we have reduced it from ~106 lines of code to just ~30.  This is the final improved query:</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE StackOverflow2013;
</span></span><span style="display:flex;"><span><span style="color:#719e07">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">DROP</span> <span style="color:#719e07">TABLE</span> <span style="color:#719e07">IF</span> <span style="color:#719e07">EXISTS</span> <span style="color:#719e07">#</span>UserDetail;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">CREATE</span> <span style="color:#719e07">TABLE</span> <span style="color:#719e07">#</span>UserDetail
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    UserId <span style="color:#b58900">INT</span>,
</span></span><span style="display:flex;"><span>    WebExists <span style="color:#b58900">BIT</span>,
</span></span><span style="display:flex;"><span>    WebDoesNotExist <span style="color:#b58900">BIT</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> <span style="color:#719e07">#</span>UserDetail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>    u.Id,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> u.WebsiteUrl <span style="color:#719e07">&lt;&gt;</span> <span style="color:#2aa198">&#39;&#39;</span> <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span> <span style="color:#719e07">AS</span> WebExists,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> u.WebsiteUrl <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;&#39;</span>  <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span> <span style="color:#719e07">AS</span> WebDoesNotExist
</span></span><span style="display:flex;"><span><span style="color:#719e07">FROM</span> dbo.Users u;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">SELECT</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">AND</span> u.WebExists <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalQuestionsWithURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span> <span style="color:#719e07">AND</span> u.WebExists <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalAnswersWithURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">AND</span> u.WebDoesNotExist <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalQuestionWithoutURL,
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">SUM</span>(<span style="color:#719e07">CASE</span> <span style="color:#719e07">WHEN</span> p.PostTypeId <span style="color:#719e07">=</span> <span style="color:#2aa198">2</span> <span style="color:#719e07">AND</span> u.WebDoesNotExist <span style="color:#719e07">=</span> <span style="color:#2aa198">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">THEN</span> <span style="color:#2aa198">1</span> <span style="color:#719e07">ELSE</span> <span style="color:#2aa198">0</span> <span style="color:#719e07">END</span>) <span style="color:#719e07">AS</span> TotalAnswersWithoutURL
</span></span><span style="display:flex;"><span><span style="color:#719e07">FROM</span> dbo.Posts p
</span></span><span style="display:flex;"><span><span style="color:#719e07">INNER</span> <span style="color:#719e07">JOIN</span> <span style="color:#719e07">#</span>UserDetail u <span style="color:#719e07">ON</span> p.OwnerUserId <span style="color:#719e07">=</span> u.UserId
</span></span></code></pre></div><br>
<p>Sure, you will just have to take my word for it here (<em>or do the demo yourself</em>), but just for completeness, here are the outputs of query 1 and 2:</p>
<p>Query 1 Output - <br></p>
<img src="/posts/post_images/results_4.png" alt="results" style="border: 0px solid black;">
<br>
<br>
<p>Query 2 Output - <br></p>
<img src="/posts/post_images/results_5.png" alt="results" style="border: 0px solid black;">
<br>
<br>
<br>
<br>
<h3 id="does-it-run-better">Does It Run Better?</h3>
<p>After all that effort, imagine if it performed exactly the same or, even worse, slowed down instead. ðŸ˜„
Fortunately, it does run better, significantly so, in fact.</p>
<p>Using the output from STATISTICS IO and TIME, we have the following:</p>
<ul>
<li>Logical reads are down by 74%</li>
<li>Total CPU time spent is down by 72%</li>
<li>Total elapsed time is down by 68%</li>
</ul>
<img src="/posts/post_images/stats_0.png" alt="results" style="border: 1px solid black; width: 830px; height: auto;">
<p><em>Drop it like its hawt</em></p>
<br>
<br>
<br>
<p>Thanks for reading!
<br>
<br>
<br></p>
<hr>
<p>If youâ€™ve found this post helpful or would just like to support the work I do here, consider buying me a coffee.</p>
<p><a href="https://www.buymeacoffee.com/leebrownhill" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/arial-green.png" alt="Buy Me A Coffee" style="height: 55px !important;width: 217px !important;" ></a></p>
<br>
<br>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/sql/" rel="tag">sql</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/optimisation/" rel="tag">optimisation</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/performance-tuning/" rel="tag">performance tuning</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Lee Brownhill avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">Author: Lee Brownhill</span>
	</div>
	<div class="authorbox__description">
		Lee Brownhill is a SQL Server Professional. He enjoys making SQL Server go faster
	</div>
</div>



			</div>
			
		</div>
		<style>
  .footer__container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    text-align: left;
    font-size: 0.75rem;  
  }

  @media (max-width: 600px) {
    .footer__container {
      font-size: 0.60rem;  
    }
  }

  .footer__copyright {
    flex: 1;
  }

  .footer__privacy {
    text-align: right;
  }
</style>

<footer class="footer">
  <div class="container footer__container">
    <div class="footer__copyright">
      &copy; 2025 Lee Brownhill.
      <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
    </div>
    <div class="footer__privacy">
      <a href="/privacy-policy" rel="noopener noreferrer">Privacy Policy</a>
    </div>
  </div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>